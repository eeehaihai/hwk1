<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å¤§æ ‘æ´ - é¦–é¡µ</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header>
        <div class="container header-content">
            <a href="home.html" class="logo">
                <h1>å‰å¤§æ ‘æ´</h1>
            </a>
            
            <div class="user-actions">
                <!-- è¿™é‡Œä¼šé€šè¿‡JSåŠ¨æ€æ›´æ–°ç”¨æˆ·ç™»å½•çŠ¶æ€ -->
            </div>
        </div>
    </header>
    
    <!-- æœç´¢åŒºåŸŸ -->
    <section class="search-section">
        <div class="container search-container">
            <h2>æ¢ç´¢æ ¡å›­é‡Œçš„å¥‡é—»è¶£äº‹ä¸ç”Ÿæ´»ç‚¹æ»´</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢è¯é¢˜ã€å…³é”®è¯...">
                <button onclick="searchPosts()" class="search-icon-btn">ğŸ”</button>
            </div>
        </div>
    </section>
    
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container main-content">
        <!-- è¯é¢˜åˆ—è¡¨åŒºåŸŸ -->
        <div class="topic-list">
            <a href="create-topic.html" class="create-topic-btn">å‘å¸ƒæ–°è¯é¢˜</a>
            
            <div class="topic-filter">
                <div class="filter-options">
                    <a href="#" class="active" data-category="all">å…¨éƒ¨</a>
                    <a href="#" data-category="campus_life">æ ¡å›­ç”Ÿæ´»</a>
                    <a href="#" data-category="study">å­¦ä¹ äº¤æµ</a>
                    <a href="#" data-category="secondhand">äºŒæ‰‹äº¤æ˜“</a>
                    <a href="#" data-category="lost_found">å¤±ç‰©æ‹›é¢†</a>
                </div>
                <div class="sort-options">
                    <a href="#" class="active" data-sort="newest">æœ€æ–°</a>
                    <a href="#" data-sort="hottest">çƒ­é—¨</a>
                    <!-- <a href="#" data-sort="featured">ç²¾å</a> -->
                </div>
            </div>
            
            <!-- è¯é¢˜åˆ—è¡¨ -->
            <div id="topicListContainer">
                <!-- è¿™é‡Œå°†é€šè¿‡JSåŠ¨æ€åŠ è½½è¯é¢˜åˆ—è¡¨ -->
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ åŒºåŸŸ -->
        <div class="sidebar">
            <!-- çƒ­é—¨åˆ†ç±» -->
            <div class="sidebar-widget">
                <h3>çƒ­é—¨åˆ†ç±»</h3>
                <ul class="category-list" id="categoryCounts">
                    <!-- è¿™é‡Œå°†é€šè¿‡JSåŠ¨æ€åŠ è½½åˆ†ç±»è®¡æ•° -->
                </ul>
            </div>
            
            <!-- çƒ­é—¨è¯é¢˜ -->
            <div class="sidebar-widget">
                <h3>çƒ­é—¨è¯é¢˜</h3>
                <ul class="hot-topics" id="hotTopics">
                    <!-- è¿™é‡Œå°†é€šè¿‡JSåŠ¨æ€åŠ è½½çƒ­é—¨è¯é¢˜ -->
                </ul>
            </div>
            
            <!-- ç”¨æˆ·æ’è¡Œ -->
            <div class="sidebar-widget">
                <h3>æ´»è·ƒç”¨æˆ·æ¦œ</h3>
                <ul class="category-list" id="activeUsers">
                    <!-- è¿™é‡Œå°†é€šè¿‡JSåŠ¨æ€åŠ è½½æ´»è·ƒç”¨æˆ· -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„šåŒºåŸŸ -->
    <footer>
        <div class="container footer-content">
            <div class="footer-links">
                <div>
                    <h4>å‹æƒ…é“¾æ¥</h4>
                    <ul>
                        <li><a href="https://www.jlu.edu.cn/" target="_blank">å‰æ—å¤§å­¦å®˜ç½‘</a></li>
                        <li><a href="https://jdjyw.jlu.edu.cn/">å‰å¤§å°±ä¸šç½‘</a></li>
                        <li><a href="http://lib.jlu.edu.cn">å‰å¤§å›¾ä¹¦é¦†</a></li>
                        <li><a href="https://ehall.jlu.edu.cn/">ç½‘ä¸ŠåŠäº‹å¤§å…</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <div class="container">
                Copyright &copy; 2025 å‰å¤§æ ‘æ´ All Rights Reserved. å‰ICPå¤‡XXXXXXXXå·
            </div>
        </div>
    </footer>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€
            updateNavUserStatus();
            
            // åŠ è½½å¹¶æ˜¾ç¤ºè¯é¢˜åˆ—è¡¨
            loadTopics();
            
            // åŠ è½½åˆ†ç±»ç»Ÿè®¡
            updateCategoryCounts();
            
            // åŠ è½½çƒ­é—¨è¯é¢˜
            loadHotTopics();
            
            // åŠ è½½æ´»è·ƒç”¨æˆ·
            loadActiveUsers();

            // æ¢å¤æ»šåŠ¨ä½ç½®
            const scrollPosition = sessionStorage.getItem('homeScrollPosition');
            if (scrollPosition) {
                window.scrollTo(0, parseInt(scrollPosition, 10));
                sessionStorage.removeItem('homeScrollPosition'); // ä½¿ç”¨åæ¸…é™¤
            }
            
            // è®¾ç½®åˆ†ç±»ç­›é€‰ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.filter-options a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // ç§»é™¤ä¹‹å‰çš„activeç±»
                    document.querySelectorAll('.filter-options a').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»é¡¹
                    this.classList.add('active');
                    
                    // æ ¹æ®åˆ†ç±»ç­›é€‰è¯é¢˜
                    const category = this.getAttribute('data-category');
                    loadTopics(category);
                });
            });
            
            // è®¾ç½®æ’åºç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.sort-options a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // ç§»é™¤ä¹‹å‰çš„activeç±»
                    document.querySelectorAll('.sort-options a').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»é¡¹
                    this.classList.add('active');
                    
                    // æ ¹æ®æ’åºæ–¹å¼åŠ è½½è¯é¢˜
                    const sortBy = this.getAttribute('data-sort');
                    const category = document.querySelector('.filter-options a.active').getAttribute('data-category');
                    loadTopics(category, sortBy);
                });
            });
        });
        
        // æŸ¥çœ‹è¯é¢˜è¯¦æƒ…
        function viewTopic(id) {
            sessionStorage.setItem('homeScrollPosition', window.scrollY); // ä¿å­˜æ»šåŠ¨ä½ç½®
            window.location.href = `topic-detail.html?id=${id}`;
        }
        
        // è¯é¢˜å¡ç‰‡åˆ›å»ºå‡½æ•°
        function createTopicCard(post) {
            const topicCard = document.createElement('div');
            topicCard.className = 'topic-card';
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°æˆªæ–­é•¿æ–‡æœ¬
            const contentPreview = truncateText(post.content);
            
            // ä½¿ç”¨é€šç”¨å‡½æ•°å¤„ç†HTMLå®‰å…¨
            topicCard.innerHTML = `
                <div class="topic-header">
                    <h3 class="topic-title">${safeHtml(post.title)}</h3>
                    <span class="topic-category">${safeHtml(post.categoryName)}</span>
                </div>
                <div class="topic-meta">
                    <span class="topic-author">${safeHtml(post.author)}</span>
                    <span class="topic-time">${formatTime(post.timestamp)}</span>
                    <span class="topic-views">æµè§ˆ ${post.views}</span>
                </div>
                <div class="topic-content">${safeHtml(contentPreview)}</div>
                <div class="topic-footer">
                    <div class="topic-stats">
                        <span class="like-btn" onclick="likeTopicInList('${post.id}', event)">
                            <span class="like-icon">â¤</span> ç‚¹èµ <span class="like-count">${post.likes || 0}</span>
                        </span>
                        <span>è¯„è®º ${post.comments || 0}</span>
                    </div>
                    <div class="topic-action">
                        <a href="#" onclick="event.preventDefault(); event.stopPropagation(); viewTopic('${post.id}');">å‚ä¸è®¨è®º</a>
                    </div>
                </div>
            `;
            
            // å¢åŠ ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½
            topicCard.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯ç‚¹èµæŒ‰é’®ï¼Œä¸è¦è·³è½¬
                if (e.target.closest('.like-btn')) {
                    return;
                }
                viewTopic(post.id);
            });
            
            return topicCard;
        }
        
        // åŠ è½½è¯é¢˜åˆ—è¡¨
        function loadTopics(category = 'all', sortBy = 'newest') {
            const topicListContainer = document.getElementById('topicListContainer');
            topicListContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('GET', `topics.php?category=${category}&sortBy=${sortBy}`, null, 
                function(response) {
                    if (response.success) {
                        const posts = response.topics;
                        
                        // å¦‚æœæ²¡æœ‰å¸–å­ï¼Œæ˜¾ç¤ºæç¤º
                        if (posts.length === 0) {
                            topicListContainer.innerHTML = '<div class="no-topics">æš‚æ— è¯é¢˜ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€ä¸ªè¯é¢˜å§ï¼</div>';
                            return;
                        }
                        
                        // æ¸…ç©ºåŠ è½½æç¤º
                        topicListContainer.innerHTML = '';
                        
                        // æ˜¾ç¤ºæ¯ä¸ªå¸–å­
                        posts.forEach(post => {
                            const topicCard = createTopicCard(post);
                            topicListContainer.appendChild(topicCard);
                        });
                    } else {
                        topicListContainer.innerHTML = `<div class="no-topics">åŠ è½½è¯é¢˜å¤±è´¥: ${safeHtml(response.message)}</div>`;
                    }
                },
                function() {
                    topicListContainer.innerHTML = '<div class="no-topics">æœåŠ¡å™¨è¿æ¥é”™è¯¯ï¼Œè¯·ç¨åå†è¯•</div>';
                }
            );
        }
        
        // åœ¨åˆ—è¡¨é¡µç‚¹èµè¯é¢˜
        function likeTopicInList(topicId, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯é¢˜å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶
            
            const likeBtn = event.currentTarget;
            const likeCountEl = likeBtn.querySelector('.like-count');
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('POST', 'like_topic.php', { topicId: topicId },
                function(response) {
                    if (response.success) {
                        // æ›´æ–°æ˜¾ç¤ºçš„ç‚¹èµæ•°
                        likeCountEl.textContent = response.likes;
                    } else {
                        console.error('ç‚¹èµå¤±è´¥:', response.message);
                        alert(response.message || 'ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    }
                },
                function() {
                    console.error('ç‚¹èµè¯·æ±‚å¤±è´¥');
                }
            );
        }
        
        // æ›´æ–°åˆ†ç±»ç»Ÿè®¡
        function updateCategoryCounts() {
            const categoryCountsEl = document.getElementById('categoryCounts');
            
            getAllPosts(function(posts) {
                // ç»Ÿè®¡æ¯ä¸ªåˆ†ç±»çš„æ•°é‡
                const categoryCounts = {
                    'campus_life': 0,
                    'study': 0,
                    'secondhand': 0,
                    'lost_found': 0
                    // 'emotion': 0, // Removed
                    // 'career': 0, // Removed
                    // 'entertainment': 0, // Removed
                    // 'suggestion': 0, // Removed
                    // 'other': 0 // Removed
                };
                
                posts.forEach(post => {
                    if (categoryCounts.hasOwnProperty(post.category)) {
                        categoryCounts[post.category]++;
                    } 
                    // else { // Removed 'other' handling for sidebar
                    //     categoryCounts['other']++;
                    // }
                });
                
                // æ˜¾ç¤ºåˆ†ç±»ç»Ÿè®¡
                const categoryNames = {
                    'campus_life': 'æ ¡å›­ç”Ÿæ´»',
                    'study': 'å­¦ä¹ äº¤æµ',
                    'secondhand': 'äºŒæ‰‹äº¤æ˜“',
                    'lost_found': 'å¤±ç‰©æ‹›é¢†'
                    // 'emotion': 'æƒ…æ„Ÿæ ‘æ´', // Removed
                    // 'career': 'å°±ä¸šè€ƒç ”', // Removed
                    // 'entertainment': 'å¨±ä¹ä¼‘é—²', // Removed
                    // 'suggestion': 'å»ºè®®åé¦ˆ', // Removed
                    // 'other': 'å…¶ä»–' // Removed
                };
                
                categoryCountsEl.innerHTML = '';
                
                for (const category in categoryNames) { // Iterate over categoryNames to maintain order and selection
                    if (categoryNames.hasOwnProperty(category)) {
                        const count = categoryCounts[category] || 0; // Default to 0 if no posts in category
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="#" data-category="${category}">${categoryNames[category]} <span class="category-count">${count}</span></a>`;
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        li.querySelector('a').addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // æ›´æ–°filter-optionsçš„activeçŠ¶æ€
                            document.querySelectorAll('.filter-options a').forEach(link => {
                                link.classList.remove('active');
                                if (link.getAttribute('data-category') === category) {
                                    link.classList.add('active');
                                }
                            });
                            
                            // åŠ è½½å¯¹åº”åˆ†ç±»çš„è¯é¢˜
                            loadTopics(category);
                        });
                        
                        categoryCountsEl.appendChild(li);
                    }
                }
            });
        }
        
        // åŠ è½½çƒ­é—¨è¯é¢˜
        function loadHotTopics() {
            const hotTopicsEl = document.getElementById('hotTopics');
            
            getAllPosts(function(posts) {
                // è®¡ç®—ä¸€å‘¨å‰çš„æ—¶é—´æˆ³
                const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                
                // æŒ‰çƒ­åº¦æ’åºï¼ˆæµè§ˆé‡+ç‚¹èµæ•°*2ï¼‰
                posts.sort((a, b) => (b.views + b.likes * 2) - (a.views + a.likes * 2));
                
                // åªæ˜¾ç¤ºå‰5ä¸ªçƒ­é—¨è¯é¢˜
                const topPosts = posts.slice(0, 5);
                
                hotTopicsEl.innerHTML = '';
                
                if (topPosts.length === 0) {
                    hotTopicsEl.innerHTML = '<li>æš‚æ— çƒ­é—¨è¯é¢˜</li>';
                    return;
                }
                
                topPosts.forEach(post => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#">${safeHtml(post.title)}</a>`;
                    
                    // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                    li.querySelector('a').addEventListener('click', function(e) {
                        e.preventDefault();
                        viewTopic(post.id);
                    });
                    
                    hotTopicsEl.appendChild(li);
                });
            });
        }
        
        // åŠ è½½æ´»è·ƒç”¨æˆ·
        function loadActiveUsers() {
            const activeUsersEl = document.getElementById('activeUsers');
            
            getAllPosts(function(posts) {
                // ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„å¸–å­æ•°é‡ï¼ˆæ’é™¤åŒ¿åç”¨æˆ·ï¼‰
                const userPostCounts = {};
                
                posts.forEach(post => {
                    if (post.author !== 'åŒ¿åç”¨æˆ·') {
                        userPostCounts[post.author] = (userPostCounts[post.author] || 0) + 1;
                    }
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                const users = Object.keys(userPostCounts).map(user => {
                    return {
                        username: user,
                        postCount: userPostCounts[user]
                    };
                });
                
                users.sort((a, b) => b.postCount - a.postCount);
                
                // åªæ˜¾ç¤ºå‰5ä¸ªæ´»è·ƒç”¨æˆ·
                const topUsers = users.slice(0, 5);
                
                activeUsersEl.innerHTML = '';
                
                if (topUsers.length === 0) {
                    activeUsersEl.innerHTML = '<li>æš‚æ— æ´»è·ƒç”¨æˆ·</li>';
                    return;
                }
                
                topUsers.forEach(user => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#">${safeHtml(user.username)} <span class="category-count">${user.postCount}</span></a>`;
                    activeUsersEl.appendChild(li);
                });
            });
        }
        
        // æœç´¢å¸–å­
        function searchPosts() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            const topicListContainer = document.getElementById('topicListContainer');
            topicListContainer.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
            
            getAllPosts(function(posts) {
                // æ ¹æ®å…³é”®è¯æœç´¢å¸–å­ï¼ˆæ ‡é¢˜å’Œå†…å®¹ï¼‰
                const filteredPosts = posts.filter(post => 
                    post.title.toLowerCase().includes(searchTerm) || 
                    post.content.toLowerCase().includes(searchTerm) ||
                    (post.tags && post.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
                
                // æ˜¾ç¤ºæœç´¢ç»“æœ
                if (filteredPosts.length === 0) {
                    topicListContainer.innerHTML = `<div class="no-topics">æ²¡æœ‰æ‰¾åˆ°ä¸ "${safeHtml(searchTerm)}" ç›¸å…³çš„è¯é¢˜</div>`;
                    return;
                }
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                topicListContainer.innerHTML = `<div class="search-result-info">æ‰¾åˆ° ${filteredPosts.length} ä¸ªä¸ "${safeHtml(searchTerm)}" ç›¸å…³çš„è¯é¢˜</div>`;
                
                // æ˜¾ç¤ºæ¯ä¸ªå¸–å­
                filteredPosts.forEach(post => {
                    const topicCard = createTopicCard(post);
                    topicListContainer.appendChild(topicCard);
                });
            });
        }
    </script>

    <style>
        /* ç‚¹èµæŒ‰é’®æ ·å¼ */
        .like-btn {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            color: #666;
            transition: color 0.3s;
        }

        .like-btn:hover {
            color: #e74c3c;
        }

        .like-icon {
            margin-right: 5px;
            font-size: 14px;
        }
    </style>
</body>
</html>
