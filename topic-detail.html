<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吉大树洞 - 话题详情</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
</head>
<body>
    <!-- 头部导航 -->
    <header>
        <div class="container header-content">
            <a href="home.html" class="logo">
                <img src="https://placeholder.com/40" alt="吉大树洞Logo">
                <h1>吉大树洞</h1>
            </a>
            
            <nav>
                <ul>
                    <li><a href="home.html">首页</a></li>
                    <li><a href="#">热门话题</a></li>
                    <li><a href="#">最新动态</a></li>
                    <li><a href="#">树洞指南</a></li>
                </ul>
            </nav>
            
            <div class="user-actions">
                <!-- 这里会通过JS动态更新用户登录状态 -->
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-container topic-detail-container">
            <!-- 话题详情区域 -->
            <div id="topicDetail" class="topic-detail">
                <div class="loading">正在加载话题内容...</div>
            </div>
            
            <!-- 评论列表区域 -->
            <div class="comment-section">
                <h2>全部评论 <span id="commentCount">0</span></h2>
                <div id="commentList" class="comment-list">
                    <div class="loading">正在加载评论...</div>
                </div>
            </div>
            
            <!-- 回复表单区域 -->
            <div class="reply-form-section">
                <h2>发表评论</h2>
                <form id="replyForm">
                    <div class="form-group">
                        <label for="reply_content" class="required">评论内容</label>
                        <textarea id="reply_content" name="reply_content" required placeholder="请输入您的评论内容..."></textarea>
                        <div class="tips">文明发言，友善交流</div>
                    </div>
                    
                    <div class="upload-section">
                        <label>添加图片</label>
                        <input type="file" id="images" name="images[]" class="file-input" accept="image/*" multiple>
                        <label for="images" class="file-label">选择图片</label>
                        <span id="file-count">未选择文件</span>
                        <div class="tips">最多可上传3张图片，每张不超过5MB</div>
                        <div class="files-preview" id="preview-container"></div>
                    </div>
                    
                    <div class="form-group">
                        <div class="option-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="anonymous" name="anonymous" value="1">
                                <label for="anonymous">匿名评论</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="notify" name="notify" value="1" checked>
                                <label for="notify">有人回复时通知我</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="message" class="message-box" style="display: none;"></div>
                    
                    <div class="button-group">
                        <button type="submit" id="submitReply">发表评论</button>
                    </div>
                </form>
            </div>
            
            <a href="home.html" class="nav-link">返回首页</a>
        </div>
    </div>
    
    <!-- 页脚区域 -->
    <footer>
        <div class="container footer-content">
            <div class="footer-links">
                <div>
                    <h4>友情链接</h4>
                    <ul>
                        <li><a href="https://www.jlu.edu.cn/" target="_blank">吉林大学官网</a></li>
                        <li><a href="https://jdjyw.jlu.edu.cn/">吉大就业网</a></li>
                        <li><a href="http://lib.jlu.edu.cn">吉大图书馆</a></li>
                        <li><a href="https://ehall.jlu.edu.cn/">网上办事大厅</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <div class="container">
                Copyright &copy; 2025 吉大树洞 All Rights Reserved. 吉ICP备XXXXXXXX号
            </div>
        </div>
    </footer>

    <script>
        // 获取URL中的话题ID参数
        function getTopicId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // 加载话题详情
        function loadTopicDetail() {
            const topicId = getTopicId();
            if (!topicId) {
                window.location.href = 'home.html';
                return;
            }
            
            const topicDetailEl = document.getElementById('topicDetail');
            
            // 从服务器加载话题详情
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `topics.php?id=${topicId}`, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success && response.topic) {
                            const post = response.topic;
                            
                            // 构建详情页HTML
                            const tagsHtml = post.tags && post.tags.length > 0 
                                ? `<div class="topic-tags">${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` 
                                : '';
                            
                            // 添加删除按钮（仅对作者显示）
                            const currentUser = getCurrentUser();
                            const deleteButtonHtml = (currentUser && (currentUser === post.author || currentUser === 'admin'))
                                ? `<button id="deleteButton" class="action-button delete-button" onclick="deleteTopic('${topicId}')">
                                    <span class="delete-icon">🗑️</span> 删除话题
                                  </button>`
                                : '';
                            
                            // 处理话题内容，确保HTML安全并正确显示换行
                            const safeContent = post.content
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#039;')
                                .replace(/\n/g, '<br>');
                            
                            // 添加作者信息、浏览量等
                            const topicHtml = `
                                <div class="topic-header">
                                    <h1 class="detail-title">${post.title}</h1>
                                    <span class="topic-category">${post.categoryName}</span>
                                </div>
                                <div class="topic-meta">
                                    <span class="topic-author">${post.author}</span>
                                    <span class="topic-time">${formatTime(post.timestamp)}</span>
                                    <span class="topic-views">浏览 ${post.views}</span>
                                </div>
                                <div class="topic-full-content">${safeContent}</div>
                                ${tagsHtml}
                                <div class="topic-stats">
                                    <button id="likeButton" class="action-button" onclick="likeTopic('${topicId}')">
                                        <span class="like-icon">❤</span> 点赞 <span id="likeCount">${post.likes || 0}</span>
                                    </button>
                                    <button class="action-button">
                                        <span class="comment-icon">💬</span> 评论 <span>${post.comments || 0}</span>
                                    </button>
                                    ${deleteButtonHtml}
                                </div>
                            `;
                            
                            topicDetailEl.innerHTML = topicHtml;
                            
                            // 更新页面标题
                            document.title = `${post.title} - 吉大树洞`;
                            
                            // 加载评论
                            loadComments(topicId);
                        } else {
                            topicDetailEl.innerHTML = '<div class="error-message">话题不存在或已被删除</div>';
                        }
                    } catch (e) {
                        console.error('解析话题数据出错:', e);
                        topicDetailEl.innerHTML = '<div class="error-message">解析话题数据出错，请稍后再试</div>';
                    }
                } else {
                    console.error('HTTP错误:', xhr.status);
                    topicDetailEl.innerHTML = '<div class="error-message">服务器连接错误，请稍后再试</div>';
                }
            };
            
            xhr.onerror = function() {
                console.error('网络错误');
                topicDetailEl.innerHTML = '<div class="error-message">网络错误，请检查您的连接</div>';
            };
            
            xhr.send();
        }
        
        // 删除话题
        function deleteTopic(topicId) {
            if (!confirm('确定要删除这个话题吗？此操作不可恢复！')) {
                return;
            }
            
            // 创建FormData对象
            const formData = new FormData();
            formData.append('topicId', topicId);
            
            // 发送删除请求
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'delete_topic.php', true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success) {
                            alert('话题删除成功！');
                            // 跳转到首页
                            window.location.href = 'home.html';
                        } else {
                            alert('删除失败：' + response.message);
                        }
                    } catch (e) {
                        console.error('解析响应数据出错:', e);
                        alert('删除失败：服务器响应格式错误');
                    }
                } else {
                    console.error('HTTP错误:', xhr.status);
                    alert('删除失败：服务器连接错误');
                }
            };
            
            xhr.onerror = function() {
                console.error('网络错误');
                alert('删除失败：网络错误');
            };
            
            xhr.send(formData);
        }
        
        // 点赞功能
        function likeTopic(topicId) {
            const likeCountEl = document.getElementById('likeCount');
            
            // 发送点赞请求到服务器
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'like_topic.php', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            // 更新显示的点赞数
                            likeCountEl.textContent = response.likes;
                        } else {
                            console.error('点赞失败:', response.message);
                            alert(response.message || '点赞失败，请稍后再试');
                        }
                    } catch (e) {
                        console.error('解析点赞响应出错:', e);
                    }
                }
            };
            
            xhr.send(`topicId=${topicId}`);
        }
        
        // 加载话题的评论
        function loadComments(topicId) {
            const commentListEl = document.getElementById('commentList');
            const commentCountEl = document.getElementById('commentCount');
            
            // 从服务器加载评论
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `comments.php?topicId=${topicId}`, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success) {
                            const comments = response.comments || [];
                            
                            // 更新评论数量
                            commentCountEl.textContent = comments.length;
                            
                            // 如果没有评论
                            if (comments.length === 0) {
                                commentListEl.innerHTML = '<div class="no-comments">暂无评论，快来发表第一条评论吧！</div>';
                                return;
                            }
                            
                            // 显示所有评论
                            commentListEl.innerHTML = '';
                            comments.forEach((comment, index) => {
                                const commentEl = document.createElement('div');
                                commentEl.className = 'comment-item';
                                
                                // 处理评论内容，确保HTML安全并正确显示换行
                                const safeContent = comment.content
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#039;')
                                    .replace(/\n/g, '<br>');
                                
                                commentEl.innerHTML = `
                                    <div class="comment-header">
                                        <span class="comment-author">${comment.author}</span>
                                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                                    </div>
                                    <div class="comment-content">${safeContent}</div>
                                    <div class="comment-footer">
                                        <button class="comment-like" onclick="likeComment('${topicId}', '${comment.id}')">
                                            点赞 <span>${comment.likes || 0}</span>
                                        </button>
                                        <button class="comment-reply" onclick="replyToComment('${comment.author}')">
                                            回复
                                        </button>
                                    </div>
                                `;
                                
                                commentListEl.appendChild(commentEl);
                            });
                        } else {
                            commentListEl.innerHTML = '<div class="error-message">加载评论失败</div>';
                        }
                    } catch (e) {
                        console.error('解析评论数据出错:', e);
                        commentListEl.innerHTML = '<div class="error-message">解析评论数据出错，请稍后再试</div>';
                    }
                } else {
                    console.error('HTTP错误:', xhr.status);
                    commentListEl.innerHTML = '<div class="error-message">服务器连接错误，请稍后再试</div>';
                }
            };
            
            xhr.onerror = function() {
                console.error('网络错误');
                commentListEl.innerHTML = '<div class="error-message">网络错误，请检查您的连接</div>';
            };
            
            xhr.send();
        }
        
        // 点赞评论
        function likeComment(topicId, commentId) {
            // 实际项目中应该发送请求到服务器更新点赞数
            const likeBtn = event.currentTarget;
            const likeCountEl = likeBtn.querySelector('span');
            const currentLikes = parseInt(likeCountEl.textContent || '0');
            likeCountEl.textContent = currentLikes + 1;
        }
        
        // 回复某人评论
        function replyToComment(username) {
            const replyContentEl = document.getElementById('reply_content');
            replyContentEl.value = `@${username} `;
            replyContentEl.focus();
        }
        
        // 处理图片预览
        document.getElementById('images').addEventListener('change', function(e) {
            const fileCount = e.target.files.length;
            document.getElementById('file-count').textContent = 
                fileCount > 0 ? `已选择 ${fileCount} 个文件` : '未选择文件';
            
            // 简单的预览功能
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            
            for(let i = 0; i < Math.min(fileCount, 3); i++) {
                const file = e.target.files[i];
                if(file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '4px';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        });
        
        // 处理评论提交
        document.getElementById('replyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 检查登录状态
            if (!isLoggedIn()) {
                alert('请先登录后再发表评论');
                window.location.href = 'login.html';
                return;
            }
            
            const topicId = getTopicId();
            const content = document.getElementById('reply_content').value.trim();
            const anonymous = document.getElementById('anonymous').checked;
            
            if (!content) {
                alert('评论内容不能为空');
                return;
            }
            
            // 创建FormData对象
            const formData = new FormData();
            formData.append('topicId', topicId);
            formData.append('content', content);
            formData.append('anonymous', anonymous ? '1' : '0');
            
            // 发送请求到服务器
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'comments.php', true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success) {
                            // 显示成功消息
                            const messageEl = document.getElementById('message');
                            messageEl.innerHTML = '评论发表成功！';
                            messageEl.className = 'message-box success';
                            messageEl.style.display = 'block';
                            
                            // 清空表单
                            document.getElementById('reply_content').value = '';
                            document.getElementById('preview-container').innerHTML = '';
                            document.getElementById('file-count').textContent = '未选择文件';
                            
                            // 重新加载评论
                            setTimeout(() => {
                                messageEl.style.display = 'none';
                                loadComments(topicId);
                            }, 1500);
                        } else {
                            // 显示错误消息
                            const messageEl = document.getElementById('message');
                            messageEl.innerHTML = response.message || '评论发表失败，请稍后再试！';
                            messageEl.className = 'message-box error';
                            messageEl.style.display = 'block';
                        }
                    } catch (e) {
                        console.error('解析响应数据出错:', e);
                        const messageEl = document.getElementById('message');
                        messageEl.innerHTML = '服务器响应格式错误，请稍后再试！';
                        messageEl.className = 'message-box error';
                        messageEl.style.display = 'block';
                    }
                } else {
                    console.error('HTTP错误:', xhr.status);
                    const messageEl = document.getElementById('message');
                    messageEl.innerHTML = '服务器连接错误，请稍后再试！';
                    messageEl.className = 'message-box error';
                    messageEl.style.display = 'block';
                }
            };
            
            xhr.onerror = function() {
                console.error('网络错误');
                const messageEl = document.getElementById('message');
                messageEl.innerHTML = '网络错误，请检查您的连接！';
                messageEl.className = 'message-box error';
                messageEl.style.display = 'block';
            };
            
            xhr.send(formData);
        });
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            // 更新导航栏用户状态
            updateNavUserStatus();
            
            // 加载话题详情
            loadTopicDetail();
        });
    </script>

    <style>
        /* 删除按钮样式 */
        .delete-button {
            background-color: #f8d7da;
            color: #721c24;
            margin-left: auto;
        }
        
        .delete-button:hover {
            background-color: #f5c6cb;
        }
        
        .delete-icon {
            margin-right: 5px;
        }
        
        /* 话题详情页额外样式 */
        .topic-detail-container {
            max-width: 900px;
            padding: 25px;
            overflow-x: hidden; /* 防止水平溢出 */
        }
        
        .topic-detail {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* 确保表单内的元素不会溢出 */
        .reply-form-section textarea {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</body>
</html>
