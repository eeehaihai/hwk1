<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å¤§æ ‘æ´ - è¯é¢˜è¯¦æƒ…</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header>
        <div class="container header-content">
            <a href="home.html" class="logo">
                <h1>å‰å¤§æ ‘æ´</h1>
            </a>
            
            <div class="user-actions">
                <!-- è¿™é‡Œä¼šé€šè¿‡JSåŠ¨æ€æ›´æ–°ç”¨æˆ·ç™»å½•çŠ¶æ€ -->
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-container topic-detail-container">
            <a href="javascript:history.back();" class="nav-link-top-left button-styled-back">è¿”å›</a>
            <!-- è¯é¢˜è¯¦æƒ…åŒºåŸŸ -->
            <div id="topicDetail" class="topic-detail">
                <div class="loading">æ­£åœ¨åŠ è½½è¯é¢˜å†…å®¹...</div>
            </div>
            
            <!-- è¯„è®ºåˆ—è¡¨åŒºåŸŸ -->
            <div class="comment-section">
                <h2>å…¨éƒ¨è¯„è®º <span id="commentCount">0</span></h2>
                <div id="commentList" class="comment-list">
                    <div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>
                </div>
            </div>
            
            <!-- å›å¤è¡¨å•åŒºåŸŸ -->
            <div class="reply-form-section">
                <h2>å‘è¡¨è¯„è®º</h2>
                <form id="replyForm">
                    <div class="form-group">
                        <label for="reply_content" class="required">è¯„è®ºå†…å®¹</label>
                        <textarea id="reply_content" name="reply_content" required placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®ºå†…å®¹..."></textarea>
                        <div class="tips">æ–‡æ˜å‘è¨€ï¼Œå‹å–„äº¤æµ</div>
                    </div>
                    
                    <div class="upload-section">
                        <label>æ·»åŠ å›¾ç‰‡</label>
                        <input type="file" id="images" name="images[]" class="file-input" accept="image/*" multiple>
                        <label for="images" class="file-label">é€‰æ‹©å›¾ç‰‡</label>
                        <span id="file-count">æœªé€‰æ‹©æ–‡ä»¶</span>
                        <div class="tips">æœ€å¤šå¯ä¸Šä¼ 3å¼ å›¾ç‰‡ï¼Œæ¯å¼ ä¸è¶…è¿‡5MB</div>
                        <div class="files-preview" id="preview-container"></div>
                    </div>
                    
                    <div class="form-group">
                        <div class="option-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="anonymous" name="anonymous" value="1">
                                <label for="anonymous">åŒ¿åè¯„è®º</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="message" class="message-box" style="display: none;"></div>
                    
                    <div class="button-group">
                        <button type="submit" id="submitReply">å‘è¡¨è¯„è®º</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„šåŒºåŸŸ -->
    <footer>
        <div class="container footer-content">
            <div class="footer-links">
                <div>
                    <h4>å‹æƒ…é“¾æ¥</h4>
                    <ul>
                        <li><a href="https://www.jlu.edu.cn/" target="_blank">å‰æ—å¤§å­¦å®˜ç½‘</a></li>
                        <li><a href="https://jdjyw.jlu.edu.cn/">å‰å¤§å°±ä¸šç½‘</a></li>
                        <li><a href="http://lib.jlu.edu.cn">å‰å¤§å›¾ä¹¦é¦†</a></li>
                        <li><a href="https://ehall.jlu.edu.cn/">ç½‘ä¸ŠåŠäº‹å¤§å…</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <div class="container">
                Copyright &copy; 2025 å‰å¤§æ ‘æ´ All Rights Reserved. å‰ICPå¤‡XXXXXXXXå·
            </div>
        </div>
    </footer>

    <script>
        // è·å–URLä¸­çš„è¯é¢˜IDå‚æ•°
        function getTopicId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // åŠ è½½è¯é¢˜è¯¦æƒ…
        function loadTopicDetail() {
            const topicId = getTopicId();
            if (!topicId) {
                window.location.href = 'home.html';
                return;
            }
            
            const topicDetailEl = document.getElementById('topicDetail');
            topicDetailEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è¯é¢˜å†…å®¹...</div>';
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('GET', `topics.php?id=${topicId}`, null,
                function(response) {
                    if (response.success && response.topic) {
                        const post = response.topic;
                        
                        // æ„å»ºè¯¦æƒ…é¡µHTML
                        const tagsHtml = post.tags && post.tags.length > 0 
                            ? `<div class="topic-tags">${post.tags.map(tag => `<span class="tag">${safeHtml(tag)}</span>`).join('')}</div>` 
                            : '';
                        
                        // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆä»…å¯¹ä½œè€…æ˜¾ç¤ºï¼‰
                        const currentUser = getCurrentUser();
                        const deleteButtonHtml = (currentUser && (currentUser === post.author || currentUser === 'admin'))
                            ? `<button id="deleteButton" class="action-button delete-button" onclick="deleteTopic('${topicId}')">
                                <span class="delete-icon">ğŸ—‘ï¸</span> åˆ é™¤è¯é¢˜
                              </button>`
                            : '';
                        
                        // å¤„ç†è¯é¢˜å†…å®¹ï¼Œç¡®ä¿HTMLå®‰å…¨å¹¶æ­£ç¡®æ˜¾ç¤ºæ¢è¡Œ
                        const safeContent = safeHtml(post.content).replace(/\n/g, '<br>');
                        
                        // æ„å»ºå›¾ç‰‡HTML
                        const imagesHtml = post.images && post.images.length > 0 
                            ? `<div class="topic-images-container">
                                ${post.images.map(imgPath => `<img src="${safeHtml(imgPath)}" alt="è¯é¢˜å›¾ç‰‡" class="topic-image" onclick="openImageModal(this.src)">`).join('')}
                               </div>`
                            : '';

                        // æ·»åŠ ä½œè€…ä¿¡æ¯ã€æµè§ˆé‡ç­‰
                        const topicHtml = `
                            <div class="topic-header">
                                <h1 class="detail-title">${safeHtml(post.title)}</h1>
                                <span class="topic-category">${safeHtml(post.categoryName)}</span>
                            </div>
                            <div class="topic-meta">
                                <span class="topic-author">${safeHtml(post.author)}</span>
                                <span class="topic-time">${formatTime(post.timestamp)}</span>
                                <span class="topic-views">æµè§ˆ ${post.views}</span>
                            </div>
                            <div class="topic-full-content">${safeContent}</div>
                            ${imagesHtml}
                            ${tagsHtml}
                            <div class="topic-stats">
                                <button id="likeButton" class="action-button" onclick="likeTopic('${topicId}')">
                                    <span class="like-icon">â¤</span> ç‚¹èµ <span id="likeCount">${post.likes || 0}</span>
                                </button>
                                <button class="action-button">
                                    <span class="comment-icon">ğŸ’¬</span> è¯„è®º <span>${post.comments || 0}</span>
                                </button>
                                ${deleteButtonHtml}
                            </div>
                        `;
                        
                        topicDetailEl.innerHTML = topicHtml;
                        
                        // æ›´æ–°é¡µé¢æ ‡é¢˜
                        document.title = `${post.title} - å‰å¤§æ ‘æ´`;
                        
                        // åŠ è½½è¯„è®º
                        loadComments(topicId);
                    } else {
                        topicDetailEl.innerHTML = '<div class="error-message">è¯é¢˜ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</div>';
                    }
                },
                function() {
                    topicDetailEl.innerHTML = '<div class="error-message">ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥</div>';
                }
            );
        }
        
        // åˆ é™¤è¯é¢˜
        function deleteTopic(topicId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('POST', 'delete_topic.php', { topicId: topicId },
                function(response) {
                    if (response.success) {
                        alert('è¯é¢˜åˆ é™¤æˆåŠŸï¼');
                        // è·³è½¬åˆ°é¦–é¡µ
                        window.location.href = 'home.html';
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + response.message);
                    }
                },
                function() {
                    alert('åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
                }
            );
        }
        
        // ç‚¹èµåŠŸèƒ½
        function likeTopic(topicId) {
            const likeCountEl = document.getElementById('likeCount');
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('POST', 'like_topic.php', { topicId: topicId },
                function(response) {
                    if (response.success) {
                        // æ›´æ–°æ˜¾ç¤ºçš„ç‚¹èµæ•°
                        likeCountEl.textContent = response.likes;
                    } else {
                        console.error('ç‚¹èµå¤±è´¥:', response.message);
                        alert(response.message || 'ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    }
                },
                function() {
                    console.error('ç‚¹èµè¯·æ±‚å¤±è´¥');
                }
            );
        }
        
        // åŠ è½½è¯é¢˜çš„è¯„è®º
        function loadComments(topicId) {
            const commentListEl = document.getElementById('commentList');
            const commentCountEl = document.getElementById('commentCount');
            
            commentListEl.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>';
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('GET', `comments.php?topicId=${topicId}`, null,
                function(response) {
                    if (response.success) {
                        const comments = response.comments || [];
                        
                        // æ›´æ–°è¯„è®ºæ•°é‡
                        commentCountEl.textContent = comments.length;
                        
                        // å¦‚æœæ²¡æœ‰è¯„è®º
                        if (comments.length === 0) {
                            commentListEl.innerHTML = '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>';
                            return;
                        }
                        
                        // æ˜¾ç¤ºæ‰€æœ‰è¯„è®º
                        commentListEl.innerHTML = '';
                        comments.forEach((comment, index) => {
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment-item';
                            
                            // å¤„ç†è¯„è®ºå†…å®¹ï¼Œç¡®ä¿HTMLå®‰å…¨å¹¶æ­£ç¡®æ˜¾ç¤ºæ¢è¡Œ
                            const safeContent = safeHtml(comment.content).replace(/\n/g, '<br>');
                            
                            // æ„å»ºè¯„è®ºå›¾ç‰‡HTML
                            const commentImagesHtml = comment.images && comment.images.length > 0
                                ? `<div class="comment-images-container">
                                    ${comment.images.map(imgPath => `<img src="${safeHtml(imgPath)}" alt="è¯„è®ºå›¾ç‰‡" class="comment-image" onclick="openImageModal(this.src)">`).join('')}
                                   </div>`
                                : '';

                            commentEl.innerHTML = `
                                <div class="comment-header">
                                    <span class="comment-author">${safeHtml(comment.author)}</span>
                                    <span class="comment-time">${formatTime(comment.timestamp)}</span>
                                </div>
                                <div class="comment-content">${safeContent}</div>
                                ${commentImagesHtml}
                                <div class="comment-footer">
                                    <button class="comment-like" onclick="likeComment('${topicId}', '${comment.id}', event)">
                                        ç‚¹èµ <span>${comment.likes || 0}</span>
                                    </button>
                                    <button class="comment-reply" onclick="replyToComment('${safeHtml(comment.author)}')">
                                        å›å¤
                                    </button>
                                </div>
                            `;
                            
                            commentListEl.appendChild(commentEl);
                        });
                    } else {
                        commentListEl.innerHTML = '<div class="error-message">åŠ è½½è¯„è®ºå¤±è´¥</div>';
                    }
                },
                function() {
                    commentListEl.innerHTML = '<div class="error-message">ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥</div>';
                }
            );
        }
        
        // ç‚¹èµè¯„è®º
        function likeComment(topicId, commentId, event) {
            // å®é™…é¡¹ç›®ä¸­åº”è¯¥å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨æ›´æ–°ç‚¹èµæ•°
            const likeBtn = event.currentTarget;
            const likeCountEl = likeBtn.querySelector('span');
            const currentLikes = parseInt(likeCountEl.textContent || '0');
            likeCountEl.textContent = currentLikes + 1;
        }
        
        // å›å¤æŸäººè¯„è®º
        function replyToComment(username) {
            const replyContentEl = document.getElementById('reply_content');
            replyContentEl.value = `@${username} `;
            replyContentEl.focus();
        }
        
        // å¤„ç†å›¾ç‰‡é¢„è§ˆ
        document.getElementById('images').addEventListener('change', function(e) {
            const fileCount = e.target.files.length;
            document.getElementById('file-count').textContent = 
                fileCount > 0 ? `å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶` : 'æœªé€‰æ‹©æ–‡ä»¶';
            
            // ç®€å•çš„é¢„è§ˆåŠŸèƒ½
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            
            for(let i = 0; i < Math.min(fileCount, 3); i++) {
                const file = e.target.files[i];
                if(file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '4px';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        });
        
        // å¤„ç†è¯„è®ºæäº¤
        document.getElementById('replyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isLoggedIn()) {
                alert('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º');
                window.location.href = 'login.html';
                return;
            }
            
            const topicId = getTopicId();
            const content = document.getElementById('reply_content').value.trim();
            const anonymous = document.getElementById('anonymous').checked;
            const imagesInput = document.getElementById('images'); // è·å–æ–‡ä»¶è¾“å…¥å…ƒç´ 
            
            if (!content) {
                alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const messageEl = document.getElementById('message');
            messageEl.style.display = 'none';
            
            // åˆ›å»ºè¡¨å•æ•°æ®
            const formData = new FormData(); // æ”¹ä¸º FormData å¯¹è±¡
            formData.append('topicId', topicId);
            formData.append('content', content);
            formData.append('anonymous', anonymous ? '1' : '0');
            
            // è¿½åŠ å›¾ç‰‡æ–‡ä»¶
            if (imagesInput.files.length > 0) {
                for (let i = 0; i < imagesInput.files.length; i++) {
                    formData.append('images[]', imagesInput.files[i]);
                }
            }
            
            // ä½¿ç”¨é€šç”¨AJAXè¯·æ±‚å‡½æ•°
            sendAjaxRequest('POST', 'comments.php', formData,
                function(response) {
                    if (response.success) {
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        messageEl.innerHTML = 'è¯„è®ºå‘è¡¨æˆåŠŸï¼';
                        messageEl.className = 'message-box success';
                        messageEl.style.display = 'block';
                        
                        // æ¸…ç©ºè¡¨å•
                        document.getElementById('reply_content').value = '';
                        document.getElementById('preview-container').innerHTML = '';
                        document.getElementById('file-count').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                        imagesInput.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
                        
                        // é‡æ–°åŠ è½½è¯„è®º
                        setTimeout(() => {
                            messageEl.style.display = 'none';
                            loadComments(topicId);
                        }, 1500);
                    } else {
                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                        messageEl.innerHTML = response.message || 'è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼';
                        messageEl.className = 'message-box error';
                        messageEl.style.display = 'block';
                    }
                },
                function() {
                    // æ˜¾ç¤ºç½‘ç»œé”™è¯¯æ¶ˆæ¯
                    messageEl.innerHTML = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥ï¼';
                    messageEl.className = 'message-box error';
                    messageEl.style.display = 'block';
                }
            );
        });
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€
            updateNavUserStatus();
            
            // åŠ è½½è¯é¢˜è¯¦æƒ…
            loadTopicDetail();
        });

        // æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImageSrc');
            if (modal && modalImg) {
                modal.style.display = "block";
                modalImg.src = src;
            }
        }

        // å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.style.display = "none";
            }
        }
    </script>

    <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal-btn" onclick="closeImageModal()">&times;</span>
        <img class="modal-content-image" id="modalImageSrc">
    </div>

    <style>
        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-button {
            background-color: #f8d7da;
            color: #721c24;
            margin-left: auto;
        }
        
        .delete-button:hover {
            background-color: #f5c6cb;
        }
        
        .delete-icon {
            margin-right: 5px;
        }
        
        /* è¯é¢˜è¯¦æƒ…é¡µé¢å¤–æ ·å¼ */
        .topic-detail-container {
            max-width: 900px;
            padding: 25px;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æº¢å‡º */
        }
        
        .topic-detail {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ç¡®ä¿è¡¨å•å†…çš„å…ƒç´ ä¸ä¼šæº¢å‡º */
        .reply-form-section textarea {
            width: 100%;
            box-sizing: border-box;
        }

        /* å›¾ç‰‡å®¹å™¨å’Œå›¾ç‰‡æ ·å¼ */
        .topic-images-container, .comment-images-container {
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* å›¾ç‰‡ä¹‹é—´çš„é—´éš™ */
        }

        .topic-image, .comment-image {
            max-width: 150px; /* é™åˆ¶å›¾ç‰‡æœ€å¤§å®½åº¦ */
            max-height: 150px; /* é™åˆ¶å›¾ç‰‡æœ€å¤§é«˜åº¦ */
            border-radius: 4px; /* å›¾ç‰‡åœ†è§’ */
            object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹å¹¶å¡«å…… */
            border: 1px solid #ddd; /* å›¾ç‰‡è¾¹æ¡† */
            cursor: pointer; /* æ·»åŠ æ‰‹å‹å…‰æ ‡ */
        }

        /* å›¾ç‰‡æ¨¡æ€æ¡†æ ·å¼ */
        .image-modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; /* å›ºå®šå®šä½ */
            z-index: 1001; /* ç½®äºé¡¶å±‚ */
            padding-top: 50px; /* é¡¶éƒ¨å†…è¾¹è· */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            background-color: rgba(0,0,0,0.85); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        }

        .modal-content-image {
            margin: auto;
            display: block;
            max-width: 85%;
            max-height: 85vh; /* æœ€å¤§é«˜åº¦ä¸ºè§†çª—é«˜åº¦çš„85% */
        }

        .close-modal-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-modal-btn:hover,
        .close-modal-btn:focus {
            color: #bbb;
            text-decoration: none;
        }
        
        /* æ–°å¢æ ·å¼ï¼Œç”¨äºå·¦ä¸Šè§’è¿”å›æŒ‰é’® */
        .nav-link-top-left {
            display: inline-block; 
            margin-bottom: 20px; /* å¢åŠ ä¸ä¸‹æ–¹å†…å®¹çš„é—´è· */
            text-align: left; 
        }

        .button-styled-back {
            background-color: #f0f0f0;
            color: #333;
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            border: 1px solid #ccc;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }

        .button-styled-back:hover {
            background-color: #e0e0e0;
            color: #1e3a8a;
            border-color: #adadad;
            text-decoration: none;
        }
    </style>
</body>
</html>
