<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰å¤§æ ‘æ´ - è¯é¢˜è¯¦æƒ…</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header>
        <div class="container header-content">
            <a href="home.html" class="logo">
                <img src="https://placeholder.com/40" alt="å‰å¤§æ ‘æ´Logo">
                <h1>å‰å¤§æ ‘æ´</h1>
            </a>
            
            <nav>
                <ul>
                    <li><a href="home.html">é¦–é¡µ</a></li>
                    <li><a href="#">çƒ­é—¨è¯é¢˜</a></li>
                    <li><a href="#">æœ€æ–°åŠ¨æ€</a></li>
                    <li><a href="#">æ ‘æ´æŒ‡å—</a></li>
                </ul>
            </nav>
            
            <div class="user-actions">
                <!-- è¿™é‡Œä¼šé€šè¿‡JSåŠ¨æ€æ›´æ–°ç”¨æˆ·ç™»å½•çŠ¶æ€ -->
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-container topic-detail-container">
            <!-- è¯é¢˜è¯¦æƒ…åŒºåŸŸ -->
            <div id="topicDetail" class="topic-detail">
                <div class="loading">æ­£åœ¨åŠ è½½è¯é¢˜å†…å®¹...</div>
            </div>
            
            <!-- è¯„è®ºåˆ—è¡¨åŒºåŸŸ -->
            <div class="comment-section">
                <h2>å…¨éƒ¨è¯„è®º <span id="commentCount">0</span></h2>
                <div id="commentList" class="comment-list">
                    <div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>
                </div>
            </div>
            
            <!-- å›å¤è¡¨å•åŒºåŸŸ -->
            <div class="reply-form-section">
                <h2>å‘è¡¨è¯„è®º</h2>
                <form id="replyForm">
                    <div class="form-group">
                        <label for="reply_content" class="required">è¯„è®ºå†…å®¹</label>
                        <textarea id="reply_content" name="reply_content" required placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®ºå†…å®¹..."></textarea>
                        <div class="tips">æ–‡æ˜å‘è¨€ï¼Œå‹å–„äº¤æµ</div>
                    </div>
                    
                    <div class="upload-section">
                        <label>æ·»åŠ å›¾ç‰‡</label>
                        <input type="file" id="images" name="images[]" class="file-input" accept="image/*" multiple>
                        <label for="images" class="file-label">é€‰æ‹©å›¾ç‰‡</label>
                        <span id="file-count">æœªé€‰æ‹©æ–‡ä»¶</span>
                        <div class="tips">æœ€å¤šå¯ä¸Šä¼ 3å¼ å›¾ç‰‡ï¼Œæ¯å¼ ä¸è¶…è¿‡5MB</div>
                        <div class="files-preview" id="preview-container"></div>
                    </div>
                    
                    <div class="form-group">
                        <div class="option-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="anonymous" name="anonymous" value="1">
                                <label for="anonymous">åŒ¿åè¯„è®º</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="notify" name="notify" value="1" checked>
                                <label for="notify">æœ‰äººå›å¤æ—¶é€šçŸ¥æˆ‘</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="message" class="message-box" style="display: none;"></div>
                    
                    <div class="button-group">
                        <button type="submit" id="submitReply">å‘è¡¨è¯„è®º</button>
                    </div>
                </form>
            </div>
            
            <a href="home.html" class="nav-link">è¿”å›é¦–é¡µ</a>
        </div>
    </div>
    
    <!-- é¡µè„šåŒºåŸŸ -->
    <footer>
        <div class="container footer-content">
            <div class="footer-links">
                <div>
                    <h4>å…³äºæˆ‘ä»¬</h4>
                    <ul>
                        <li><a href="#">ç½‘ç«™ç®€ä»‹</a></li>
                        <li><a href="#">è¿è¥å›¢é˜Ÿ</a></li>
                        <li><a href="#">è”ç³»æˆ‘ä»¬</a></li>
                        <li><a href="#">åŠ å…¥æˆ‘ä»¬</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4>å¸®åŠ©ä¸­å¿ƒ</h4>
                    <ul>
                        <li><a href="#">ä½¿ç”¨æŒ‡å—</a></li>
                        <li><a href="#">å¸¸è§é—®é¢˜</a></li>
                        <li><a href="#">ç”¨æˆ·åé¦ˆ</a></li>
                        <li><a href="#">å†…å®¹è§„èŒƒ</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4>å‹æƒ…é“¾æ¥</h4>
                    <ul>
                        <li><a href="https://www.jlu.edu.cn/" target="_blank">å‰æ—å¤§å­¦å®˜ç½‘</a></li>
                        <li><a href="https://jdjyw.jlu.edu.cn/">å‰å¤§å°±ä¸šç½‘</a></li>
                        <li><a href="http://lib.jlu.edu.cn">å‰å¤§å›¾ä¹¦é¦†</a></li>
                        <li><a href="https://ehall.jlu.edu.cn/">ç½‘ä¸ŠåŠäº‹å¤§å…</a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <div class="container">
                Copyright &copy; 2025 å‰å¤§æ ‘æ´ All Rights Reserved. å‰ICPå¤‡XXXXXXXXå·
            </div>
        </div>
    </footer>

    <script>
        // è·å–URLä¸­çš„è¯é¢˜IDå‚æ•°
        function getTopicId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // åŠ è½½è¯é¢˜è¯¦æƒ…
        function loadTopicDetail() {
            const topicId = getTopicId();
            if (!topicId) {
                window.location.href = 'home.html';
                return;
            }
            
            const topicKey = `post_${topicId}`;
            const topicDetailEl = document.getElementById('topicDetail');
            
            try {
                const post = JSON.parse(localStorage.getItem(topicKey));
                if (!post) {
                    topicDetailEl.innerHTML = '<div class="error-message">è¯é¢˜ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</div>';
                    return;
                }
                
                // å¢åŠ æµè§ˆé‡
                post.views = (post.views || 0) + 1;
                localStorage.setItem(topicKey, JSON.stringify(post));
                
                // æ„å»ºè¯¦æƒ…é¡µHTML
                const tagsHtml = post.tags && post.tags.length > 0 
                    ? `<div class="topic-tags">${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` 
                    : '';
                
                // æ·»åŠ ä½œè€…ä¿¡æ¯ã€æµè§ˆé‡ç­‰
                const topicHtml = `
                    <div class="topic-header">
                        <h1 class="detail-title">${post.title}</h1>
                        <span class="topic-category">${post.categoryName}</span>
                    </div>
                    <div class="topic-meta">
                        <span class="topic-author">${post.author}</span>
                        <span class="topic-time">${formatTime(post.timestamp)}</span>
                        <span class="topic-views">æµè§ˆ ${post.views}</span>
                    </div>
                    <div class="topic-full-content">${post.content}</div>
                    ${tagsHtml}
                    <div class="topic-stats">
                        <button id="likeButton" class="action-button" onclick="likeTopic('${topicId}')">
                            <span class="like-icon">â¤</span> ç‚¹èµ <span id="likeCount">${post.likes || 0}</span>
                        </button>
                        <button class="action-button">
                            <span class="comment-icon">ğŸ’¬</span> è¯„è®º <span>${post.comments || 0}</span>
                        </button>
                    </div>
                `;
                
                topicDetailEl.innerHTML = topicHtml;
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = `${post.title} - å‰å¤§æ ‘æ´`;
                
                // åŠ è½½è¯„è®º
                loadComments(topicId);
                
            } catch (e) {
                console.error('åŠ è½½è¯é¢˜å‡ºé”™:', e);
                topicDetailEl.innerHTML = '<div class="error-message">åŠ è½½è¯é¢˜å‡ºé”™ï¼Œè¯·ç¨åå†è¯•</div>';
            }
        }
        
        // ç‚¹èµåŠŸèƒ½
        function likeTopic(topicId) {
            const topicKey = `post_${topicId}`;
            try {
                const post = JSON.parse(localStorage.getItem(topicKey));
                if (post) {
                    post.likes = (post.likes || 0) + 1;
                    localStorage.setItem(topicKey, JSON.stringify(post));
                    document.getElementById('likeCount').textContent = post.likes;
                }
            } catch (e) {
                console.error('ç‚¹èµå‡ºé”™:', e);
            }
        }
        
        // åŠ è½½è¯é¢˜çš„è¯„è®º
        function loadComments(topicId) {
            const commentListEl = document.getElementById('commentList');
            const commentCountEl = document.getElementById('commentCount');
            
            // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰è¯„è®º
            const commentsKey = `comments_${topicId}`;
            let comments = [];
            try {
                const commentsData = localStorage.getItem(commentsKey);
                if (commentsData) {
                    comments = JSON.parse(commentsData);
                }
            } catch (e) {
                console.error('è§£æè¯„è®ºæ•°æ®å‡ºé”™:', e);
            }
            
            // æ›´æ–°è¯„è®ºæ•°é‡
            commentCountEl.textContent = comments.length;
            
            // å¦‚æœæ²¡æœ‰è¯„è®º
            if (comments.length === 0) {
                commentListEl.innerHTML = '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>';
                return;
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰è¯„è®º
            commentListEl.innerHTML = '';
            comments.forEach((comment, index) => {
                const commentEl = document.createElement('div');
                commentEl.className = 'comment-item';
                
                commentEl.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-footer">
                        <button class="comment-like" onclick="likeComment('${topicId}', ${index})">
                            ç‚¹èµ <span>${comment.likes || 0}</span>
                        </button>
                        <button class="comment-reply" onclick="replyToComment('${comment.author}')">
                            å›å¤
                        </button>
                    </div>
                `;
                
                commentListEl.appendChild(commentEl);
            });
        }
        
        // ç‚¹èµè¯„è®º
        function likeComment(topicId, commentIndex) {
            const commentsKey = `comments_${topicId}`;
            try {
                const commentsData = localStorage.getItem(commentsKey);
                if (commentsData) {
                    const comments = JSON.parse(commentsData);
                    if (comments[commentIndex]) {
                        comments[commentIndex].likes = (comments[commentIndex].likes || 0) + 1;
                        localStorage.setItem(commentsKey, JSON.stringify(comments));
                        
                        // æ›´æ–°æ˜¾ç¤º
                        const likeCountEl = document.querySelectorAll('.comment-like span')[commentIndex];
                        if (likeCountEl) {
                            likeCountEl.textContent = comments[commentIndex].likes;
                        }
                    }
                }
            } catch (e) {
                console.error('ç‚¹èµè¯„è®ºå‡ºé”™:', e);
            }
        }
        
        // å›å¤æŸäººè¯„è®º
        function replyToComment(username) {
            const replyContentEl = document.getElementById('reply_content');
            replyContentEl.value = `@${username} `;
            replyContentEl.focus();
        }
        
        // å¤„ç†å›¾ç‰‡é¢„è§ˆ
        document.getElementById('images').addEventListener('change', function(e) {
            const fileCount = e.target.files.length;
            document.getElementById('file-count').textContent = 
                fileCount > 0 ? `å·²é€‰æ‹© ${fileCount} ä¸ªæ–‡ä»¶` : 'æœªé€‰æ‹©æ–‡ä»¶';
            
            // ç®€å•çš„é¢„è§ˆåŠŸèƒ½
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            
            for(let i = 0; i < Math.min(fileCount, 3); i++) {
                const file = e.target.files[i];
                if(file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '4px';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        });
        
        // å¤„ç†è¯„è®ºæäº¤
        document.getElementById('replyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isLoggedIn()) {
                alert('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º');
                window.location.href = 'login.html';
                return;
            }
            
            const topicId = getTopicId();
            const content = document.getElementById('reply_content').value.trim();
            const anonymous = document.getElementById('anonymous').checked;
            
            if (!content) {
                alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // åˆ›å»ºè¯„è®ºå¯¹è±¡
            const comment = {
                content: content,
                author: anonymous ? 'åŒ¿åç”¨æˆ·' : getCurrentUser(),
                timestamp: Date.now(),
                likes: 0
            };
            
            // ä¿å­˜è¯„è®º
            try {
                const commentsKey = `comments_${topicId}`;
                let comments = [];
                
                const commentsData = localStorage.getItem(commentsKey);
                if (commentsData) {
                    comments = JSON.parse(commentsData);
                }
                
                comments.push(comment);
                localStorage.setItem(commentsKey, JSON.stringify(comments));
                
                // æ›´æ–°è¯é¢˜è¯„è®ºæ•°
                const topicKey = `post_${topicId}`;
                const post = JSON.parse(localStorage.getItem(topicKey));
                if (post) {
                    post.comments = (post.comments || 0) + 1;
                    localStorage.setItem(topicKey, JSON.stringify(post));
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const messageEl = document.getElementById('message');
                messageEl.innerHTML = 'è¯„è®ºå‘è¡¨æˆåŠŸï¼';
                messageEl.className = 'message-box success';
                messageEl.style.display = 'block';
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('reply_content').value = '';
                document.getElementById('preview-container').innerHTML = '';
                document.getElementById('file-count').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                
                // é‡æ–°åŠ è½½è¯„è®º
                setTimeout(() => {
                    messageEl.style.display = 'none';
                    loadComments(topicId);
                }, 1500);
                
            } catch (e) {
                console.error('å‘è¡¨è¯„è®ºå‡ºé”™:', e);
                const messageEl = document.getElementById('message');
                messageEl.innerHTML = 'è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼';
                messageEl.className = 'message-box error';
                messageEl.style.display = 'block';
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€
            updateNavUserStatus();
            
            // åŠ è½½è¯é¢˜è¯¦æƒ…
            loadTopicDetail();
        });
    </script>
</body>
</html>
